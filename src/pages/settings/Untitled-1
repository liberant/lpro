# DNSMadeEasy automatic DNS updates

################################ - Config - #################################
# Set the Username, Dynamic DNS ID and Password for the record to be updated.
# This info can be obtained by editing the A Record of the DDNS-enabled record.

:local dmeuser "noven"
:local ddnsid "68639203"
:local ddnspassword "VFr3q*!"

# Name of the public/external interface

:local inetinterface "WAN"

############################## - End Config - ############################

:global systemname [/system identity get name]

:global previousIP
:local currentIP


# get the current IP address from the internet (in case of double-nat)
/tool fetch mode=http address="checkip.dyn.com" src-path="/" dst-path="/dynip.txt"
:local result [/file get dynip.txt contents]


# parse the current IP result
:local resultLen [:len $result]
:local startLoc [:find $result ": " -1]
:set startLoc ($startLoc + 2)
:local endLoc [:find $result "</body>" -1]
:local currentIP [:pick $result $startLoc $endLoc]
:log info "UpdateDynDNS: currentIP = $currentIP"

:if (($currentIP != $previousIP) do={
         :set oldIP $currentIP
         :local url "http://www.dnsmadeeasy.com/servlet/updateip\3F&username=$dmeuser&password=$ddnspassword&id=$ddnsid&ip=$currentIP"
         /tool fetch url=($url) mode=http dst-path=("dmeupdate-" . $ddnsid . ".txt")
         :log info "DNSMadeEasy: Record $ddnsid updated to $currentIP
} else={
:log info ("UpdateDynDNS: No dyndns update needed")
}